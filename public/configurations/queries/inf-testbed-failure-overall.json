{
  "id": "inf-testbed-failure-overall",
  "title": "",
  "service": "elasticsearch",
  "tabify": "infraPieGraph",
  "query": {
    "index": "nuage_regress",
    "type": "nuage_doc_type",
    "body": {
      "size": 0,
      "query": {
        "bool": {
          "must": [
            {
              "range": {
                "time_regression_started": {
                  "gte": "{{startTime:now-7d}}",
                  "lte": "{{endTime:now}}",
                  "format": "epoch_millis"
                }
              }
            },
            {
              "term": {
                "testcase": ""
              }
            },
            {
              "terms": {
                "testsuite": [
                  "initial",
                  "sanity",
                  "Sanity"
                ]
              }
            },
            {
              "wildcard":{
                "testbed":"{{site}}"
              }
            }
          ]
        }
      },
      "aggs": {
        "date_histo": {
          "date_histogram": {
            "field": "time_regression_started",
            "interval": "14d"
          },
          "aggs": {
            "failed_jobs": {
              "cardinality": {
                "script": {
                  "inline": "doc['result'].value !=2 ? doc['job_id'].value : null"
                }
              }
            },
            "total_jobs": {
              "cardinality": {
                "field": "job_id"
              }
            },
            "runs_count": {
              "bucket_script": {
                "buckets_path": {
                  "failed_jobs": "failed_jobs",
                  "total_jobs": "total_jobs"
                },
                "script": "params.total_jobs - params.failed_jobs"
              }
            },
            "failed_percentage": {
              "bucket_script": {
                "buckets_path": {
                  "failed_jobs": "failed_jobs",
                  "total_jobs": "total_jobs"
                },
                "script": "params.failed_jobs/params.total_jobs * 100.0"
              }
            }
          }
        }
      }
    }
  }
}